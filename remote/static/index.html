<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>Karaoke Remote</title>

<style>
:root {
    --bg: #0d0d0d;
    --card: #1a1a1a;
    --accent: #3a7afe;
    --text: #ffffff;
    --subtext: #bbbbbb;
    --radius: 16px;
    --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
}

body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    margin: 0;
    padding: 20px;
}

/* --- Sections --- */
.sectionCard {
    margin-bottom: 40px;
    border-radius: 2rem;
    padding: 2rem;
    background-color: gray;
}

.section {
    margin-bottom: 40px;
}

.sectionTitle {
    font-size: 1.2rem;
    font-weight: 600;
    opacity: 0.8;
    margin-bottom: 12px;
    padding-left: 2px;
}

/* Centered text for header */
#header {
    text-align: center;
}

h2 {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

/* --- Controls Section --- */
.controls {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 12px;
}

/* iOS Buttons */
button {
    background: #2a2a2a;
    color: var(--text);
    border: none;
    padding: 12px 18px;
    font-size: 16px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: 0.15s;
}

button:active {
    background: #3a3a3a;
    transform: scale(0.98);
}

#accentBtn {
    background: var(--accent);
    font-weight: 600;
}
#accentBtn:active {
    background: #2f63d9;
}

/* --- Input Section --- */
.inputLabel {
    font-size: 0.9rem;
    color: var(--subtext);
    margin-bottom: 6px;
    padding-left: 3px;
}

.input-wrapper {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-block: 0.7rem;
}

.input-wrapper--left {
    justify-content: start !important;
}

input {
    flex: 1;
    max-width: 100%;
    padding: 14px 16px;
    font-size: 16px;
    border-radius: var(--radius);
    border: none;
    background: #2a2a2a;
    color: var(--text);
    outline: none;
}

/* --- Preview Card --- */
#previewBox {
    margin-top: 18px;
    background: var(--card);
    padding: 15px;
    border-radius: var(--radius);
    display: none;
    animation: fadeIn 0.2s ease-out;
}

#previewInner {
    display: flex;
    align-items: center;
    gap: 15px;
}

#previewThumb {
    width: 110px;
    height: 70px;
    object-fit: cover;
    border-radius: var(--radius);
    flex-shrink: 0;
}

#previewTitle {
    font-size: 1rem;
    margin: 0 0 4px 0;
}

#previewArtist {
    margin: 0;
    font-size: 0.85rem;
    color: var(--subtext);
}

/* --- Queue Styling --- */
#queueContainer {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
    max-height: 42vh;
    overflow-y: auto;
    padding-right: 6px;    /* prevents scrollbar overlap */
    scrollbar-width: thin; /* Firefox */
}

.queueItem {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #2a2a2a;
    padding: 10px 14px;
    border-radius: var(--radius);
    font-size: 0.95rem;
    transition: 0.2s;
}

.queueItem:nth-child(odd) {
    background: #252525;
}

.queueItem:hover {
    background: var(--accent);
    cursor: default;
}

.queueItem span {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Fix input width overflow */
#songSearch {
    box-sizing: border-box; /* ensures padding is included in width */
    width: 100%;
}

#songList {
    display: flex;
    flex-direction: column;
    gap: 12px;       /* adds vertical spacing between items */
    max-height: 40vh;
    overflow-y: auto;
}

/* Slightly increase padding inside each song item */
.queueItem {
    padding: 14px 16px; /* more breathing space */
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

</head>
<body>

<!-- HEADER SECTION -->
<div class="section" id="header">
    <h2>Karaoke Remote</h2>
    <div id="userDisplay" style="font-size: 1.3rem; opacity: 0.7;"></div>
</div>

<!-- CONTROL SECTION -->
<div class="sectionCard">
    <div class="sectionTitle">Controls</div>

    <div class="controls">
        <button onclick="send('/api/pause')">Pause</button>
        <button onclick="send('/api/skip')">Skip</button>
        <button onclick="send('/api/vocal')">Vocal</button>
    </div>
</div>

<div class="sectionCard" id="songsSection">
    <div class="sectionTitle">
        All Songs <span id="songCount" style="opacity:0.7; font-weight:500;">(0)</span>
    </div>
    <input type="text" id="songSearch" placeholder="Search songs..." style="width:100%; padding:10px; margin-bottom:10px; border-radius:16px; border:none; background:#2a2a2a; color:#fff;">
    <div id="songList" style="max-height:40vh; overflow-y:auto;"></div>
</div>

<!-- ADD SONG SECTION -->
<div class="sectionCard">
    <div class="sectionTitle">Add New Song</div>

    <div class="inputLabel">YouTube Video URL Only</div>

    <div class="input-wrapper">
        <input id="urlInput" placeholder="Paste YouTube linkâ€¦" oninput="onUrlInput()">
        <!-- <button onclick="pasteClipboard()">Paste</button> -->
    </div>
    
    <div class="input-wrapper input-wrapper--left">
        <button id="clearBtn" onclick="clearInput()" style="display:none;">Clear</button>
        <button id="accentBtn" onclick="addSong()" style="display:none;">Add</button>

    </div>

    <!-- Preview -->
    <div id="previewBox">
        <div id="previewInner">
            <img id="previewThumb">
            <div>
                <h3 id="previewTitle"></h3>
                <p id="previewArtist"></p>
            </div>
        </div>
    </div>
</div>

<!-- QUEUE SECTION -->
<div class="sectionCard" id="queueSection">
    <div style="display:flex; gap:1rem; align-items: center;">
        <div class="sectionTitle">
            Queue <span id="queueCount" style="opacity:0.7; font-weight:500;">(0)</span>
        </div>
        <button onclick="refreshQueue()" style="margin-bottom: 12px;">
            Refresh Queue
        </button>
    </div>
    <div id="queueContainer">
        <!-- Queue items will be injected here -->
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();

// ----------------------------------
// Username handling
// ----------------------------------
let username = localStorage.getItem("karaokeName");
if (!username) {
    username = prompt("Enter your name:") || "Guest";
    localStorage.setItem("karaokeName", username);
}
document.getElementById("userDisplay").innerText = "Hello, " + username + "!";

// ----------------------------------
function send(endpoint) { fetch(endpoint, { method: 'POST' }); }
// ----------------------------------

async function pasteClipboard() {
    const input = document.getElementById("urlInput");

    // iOS Safari fallback using execCommand
    input.focus();

    try {
        const successful = document.execCommand("paste");
        if (successful) return;
    } catch (e) {
        // execCommand might simply fail silently
    }

    // Modern API (works on Android + desktop Safari/Chrome)
    if (navigator.clipboard && navigator.clipboard.readText) {
        try {
            input.value = await navigator.clipboard.readText();
            return;
        } catch (e) {
            console.warn("Clipboard read failed:", e);
        }
    }

    alert("Paste is not supported on this browser. Please tap and hold to paste.");
}

let lastUrl = "";

async function onUrlInput() {
    const input = document.getElementById("urlInput");
    const url = input.value.trim();

    document.getElementById("clearBtn").style.display =
        url.length > 0 ? "inline-block" : "none";

    if (url === lastUrl) return;
    lastUrl = url;

    const isYouTube = url.includes("youtube.com") || url.includes("youtu.be");
    if (!isYouTube) {
        hidePreview();
        return;
    }

    try {
        const oembed = await fetch(
            "https://www.youtube.com/oembed?url=" + encodeURIComponent(url) + "&format=json"
        ).then(r => r.json());

        showPreview({
            title: oembed.title,
            artist: oembed.author_name,
            thumbnail: `https://img.youtube.com/vi/${extractVideoId(url)}/hqdefault.jpg`
        });
    } catch {
        hidePreview();
    }
}

function extractVideoId(url) {
    try {
        const id = new URL(url).searchParams.get("v");
        return id || url.split("/").pop();
    } catch {
        return "";
    }
}

function showPreview({ title, artist, thumbnail }) {
    let b = document.getElementById("previewBox");
    b.style.display = "block";

    document.getElementById("previewThumb").src = thumbnail;
    document.getElementById("previewTitle").innerText = title;
    document.getElementById("previewArtist").innerText = artist;

    document.getElementById("accentBtn").style.display = "inline-block";
}

function hidePreview() {
    document.getElementById("previewBox").style.display = "none";
    document.getElementById("accentBtn").style.display = "none";
}

function clearInput() {
    document.getElementById("urlInput").value = "";
    document.getElementById("clearBtn").style.display = "none";
    lastUrl = "";
    hidePreview();
}

async function addSong() {
    const url = document.getElementById("urlInput").value.trim();
    const title = document.getElementById("previewTitle").innerText;
    const artist = document.getElementById("previewArtist").innerText;

    await fetch("/add", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ url, user: username, title, artist })
    });

    clearInput();
    alert("Added: " + title);
}

async function refreshQueue() {
    try {
        const res = await fetch("/api/getQueue");
        const queue = await res.json();
        updateQueueUI(queue);
    } catch (e) {
        console.error("Failed to refresh queue:", e);
    }
}

queueContainer.id = "queueContainer";

function updateQueueUI(queue) {
    const container = document.getElementById("queueContainer");
    const queueCountEl = document.getElementById("queueCount");

    container.innerHTML = "";

    // Update queue count
    queueCountEl.innerText = `(${queue.length})`;

    if (queue.length === 0) {
        container.innerHTML = "<p style='opacity:0.6;'>Queue is empty</p>";
        return;
    }

    queue.forEach((song, idx) => {
        const div = document.createElement("div");
        div.className = "queueItem";
        div.innerHTML = `
            <span>${idx + 1}. ${song.queued_by ? "ðŸŽ¤ " + song.queued_by + " - " : ""}${song.title} - ${song.artist}</span>
        `;
        container.appendChild(div);
    });
}

socket.on("queue_update", (queue) => {
    updateQueueUI(queue);
});

const songList = document.getElementById("songList");
const songSearch = document.getElementById("songSearch");

async function fetchSongs(query="") {
    const res = await fetch(`/api/getSongs?q=${encodeURIComponent(query)}`);
    const songs = await res.json();

    const songCountEl = document.getElementById("songCount");
    songList.innerHTML = "";

    if (!songs || songs.length === 0) {
        songList.innerHTML = "<p style='opacity:0.6;'>No songs found</p>";
        songCountEl.innerText = "(0)";
        return;
    }

    // Update song count
    songCountEl.innerText = `(${songs.length})`;

    songs.forEach((song, idx) => {
        const div = document.createElement("div");
        div.className = "queueItem";

        // Create a column container
        const columnDiv = document.createElement("div");
        columnDiv.style.display = "flex";
        columnDiv.style.flexDirection = "column"; // stack items vertically
        columnDiv.style.gap = "6px";              // spacing between text and button

        // Add song text
        const textDiv = document.createElement("div");
        textDiv.innerHTML = `
            <strong>${idx + 1}. ${song.title}</strong><br>
            <span style="font-size:0.85rem; color:var(--subtext);">
                Queued: ${song.queued}
            </span>
        `;

        // Add button
        const btn = document.createElement("button");
        btn.innerText = "Add to Queue";
        btn.style.display = "none";
        btn.onclick = async (e) => {
            e.stopPropagation();
            await fetch("/add", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ url:"", user: username, title: song.title, artist: song.artist })
            });
            alert(`Queued: ${song.title}`);
            btn.style.display = "none";
        };

        // Append text and button to column container
        columnDiv.appendChild(textDiv);
        columnDiv.appendChild(btn);

        // Append column container to queue item
        div.appendChild(columnDiv);

        // Toggle button on click
        div.onclick = () => {
            btn.style.display = btn.style.display === "none" ? "inline-block" : "none";
        };

        songList.appendChild(div);
    });
}

// Live search
songSearch.addEventListener("input", () => {
    fetchSongs(songSearch.value);
});

// Initial load
fetchSongs();
</script>

</body>
</html>
